<!DOCTYPE html>
<html>
  <head>
    <title>RDF Patch &ndash; Recording changes to an RDF Dataset</title>
    <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />

    <style type="text/css">
      .box { 
          border: thin solid #888888;
          page-break-inside: avoid ;
          background-color: #F8F8F8 ; padding:1em ;
          margin-left:0 ; margin-right: 10ex; 
          margin-top: 0.1ex ; margin-bottom: 0.1ex ;
      }
    </style>

    <script src='http://www.w3.org/Tools/respec/respec-w3c-common' class='remove'></script>

    <script class='remove'>
      var respecConfig = {
          // document info
          specStatus:           "unofficial",
          shortName:            "rdf-patch",
	      editors:  [
              { name: "Andy Seaborne"
                //, 
	            //url: "http://jena.apache.org/",
                //company: "Apache Jena", 
                //companyURL: "http://jena.apache.org/"
              } ,
          ],

          // publishDate:   "2013-06-20",
          // previousMaturity: "WD",
          // previousPublishDate:  "2009-03-15",
          // previousURI : "http://dev.w3.org/2009/dap/ReSpec.js/documentation.html",
          copyrightStart:       "2013",
          // edDraftURI:           "http://dev.w3.org/2009/dap/ReSpec.js/documentation.html",
          // lcEnd:  "2010-08-06",
          // extraCSS:             ["../css/respec.css"],
          extraCSS:             ["http://dev.w3.org/2009/dap/ReSpec.js/css/respec.css"],

          // WG
          //wg:           "Apache Jena",
          //wgURI:        "http://jena.apache.org/",
          //wgPublicList: "",
          //wgPatentURI:  "",
      };
    </script>
  </head>
  <body>

    <section id='abstract'>
      <p>
        RDF Patch is a file format for recording changes made to an RDF
        dataset. It can be used for replicating changes between multiple
        copies of the same dataset or as an incremental backups format.
      </p>
    </section>

    <section>
      <h2>Introduction</h2>
      <p>
        RDF Patch is a file format for recording changes made to an RDF
        dataset. It can be used for replicating changes between multiple 
        copies of the same dataset or as an incremental backups format.
      </p>
      <p>
        The design emphasizes deployment concerns such as scalability 
        and efficient processing.
      </p>
    </section>

    <section>
      <h2>Use Cases</h2>
      <p>
        Use cases:
      </p>

      <section>
        <h3>Incremental backup</h3>
        <p>
          With a large dataset, a full backups can take a significant
          amount of time and space; if taken on a live, then it may
          introduce significant load.  By keeping an RDF Patch file to
          record changes, there is an incremental backup that can be
          applied to the last full backup.  Such a record can be much
          smaller, and not a significant load on the system during peak
          times.
        </p>
        <p>
          By taking periodic full backups and recording changes as an RDF
          Patch as incremental backups between the full backup points, an
          up-to-date version of the data can be restored, including the
          latest changes.
        </p>
      </section>

      <section>
        <h3>Replica Maintenance</h3>
        <p>
          Suppose an SPARQL server is replicated for performance or
          resilience reasons.  Each server has a complete copy of the
          database.  While there are many other issues to consider, one
          aspect is to be able to update both databases in a consistent
          manner - that is, blank nodes within the dataset are treated
          identically.
        </p>
    </section>



      <section>
        <h3>Data Staging</h3>
        <p>
          One deployment architecture is to have a master database for
          staging the data which is not available to the
          public/application-facing publication servers.  The master
          database is updated, then the changes propagated to replicas that
          support the public/application-facing read-only workload.  The
          staging database may be subject to checking and validation of
          changes before release to the production publishing servers.  In
          order to keep the production servers exactly as the master
          database, an RDF Patch file can be used because it allows blank
          nodes to be replicated.
        </p>
      </section>

    </section>


    <section>
      <h2>Example</h2>
      <p>
        This examples delta adds a <tt>foaf:knows</tt> relationship, and
        changes the <tt>foaf:name</tt> triple for Bob.
        </p>
<pre class="box">
 A &lt;http://example.org/alice> &lt;http://xmlns.com/foaf/0.1/name> "Robert" .
 A &lt;http://example.org/bob> &lt;http://xmlns.com/foaf/0.1/knows> &lt;http://example/alice> .
 A &lt;http://example.org/alice> &lt;http://xmlns.com/foaf/0.1/name> "Alice" .
 D &lt;http://example.org/alice> &lt;http://xmlns.com/foaf/0.1/name> "Robert" .
 A &lt;http://example.org/alice> &lt;http://xmlns.com/foaf/0.1/name> "Bob" .</pre>

      <p>
        <tt>A</tt> means "add", <tt>D</tt> means "delete".
      </p>
      <p>
        The order in the file is significant - the changes happened in the
        order given so the first triple added with "Robert" as Bob's name
        is removed by the later delete.
      </p>
    </section>
    <section>
      <h2>Details</h2>
      
      <p>
        An RDF Dataset is defined as a a set of a unnamed graph and zero or
        more named graphs.  For recording changes to these graphs, we
        record triples added or deleted to the default graph, and the quad
        for a named graph.  The "RDF Patch" format is based on a general
        format for "RDF tuples", which is not another serialization format
        for RDF or RDF Datasets.
      </p>
      <p>
        The format is rows of RDF terms (URIs, literals, bNodes), with each
        row ending in a "." (DOT).  Prefix names, SPARQL-styles variables
        and keywords (bare word without a ":" in them) are allowed.

      <p>
        Variables are not used by RDF Patch but other uses of RDF Tuples
        may define their use.
      </p>

      <p>
        <tt>\#</tt> starts a comment and it runs until the end of line.
        Note that RDF Tuple rows are delimited by DOT and may have white
        space between the RDF terms, including newlines.
      </p>

      <p>RDF Tuples uses the following keywords:</p>
       <table class="simple">
        <thead>
          <tr><th>Marker</th><th>Meaning</th></tr>
        </thead>
        <tbody>
           <tr>
            <td>
              <tt>R</tt>
            </td>
            <td>Repeat term from previous row</td>
          </tr>
          <tr>
            <td><tt>U</tt></td>
            <td>Term undefined (not used by RDF Tuples)</td>
          </tr>
        </tbody>
      </table>

      <p>RDF Patch puts a marker in the first item of each row:</p>

      <table class="simple">
        <thead>
          <tr><th>Marker</th><th>Meaning</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <tt>A</tt>
            </td>
            <td>Add</td>
          </tr>
          <tr>
            <td><tt>D</tt></td>
            <td>Delete</td>
          </tr>
        </tbody>
      </table>

      <p>followed by 3 or 4 RDF terms; 3 for a triple, 4 for a quad.</p>

      <p>Using RDF Tuples, RDF Patch, has the following characteristics:</p>

      <ul>
        <li>
          The unit being managed is an RDF Dataset, which is a collection
          of RDF graphs and used by SPARQL for query and for update.  RDF
          Patch can also be used to record changes to a single graph.
        </li>
        <li>
          It is streaming - changes can be applied as an RDF Patch file or
          stream read; it is not necessary to wait until the whole set of
          changes is seen before applying any of it.  Indeed, the patch
          must be applied in the order in the file to correctly apply
          changes.
        </li>
        <li>
          Blank nodes are recorded as "_:_id_" where _id_ can be the
          system-internal identifier for the blank node.  This means that
          changes involving blank nodes can be replayed to get an identical
          datasets to the one where the changes were originally made.  This
          is RDF Patch's interpretation of the <tt>\_:abc</tt> syntax;
          other uses of RDF Tuples may have different scoping rules for
          blank node labels.
        </li>
      </ul>
    </section>

    <section>
      <h3>Abbreviation, compression and readability.</h3>

      <p>
        To remove repetition, the value of an element in a row can be the
        keyword R, meaning it is the same as the previous row.  It is an
        error if there is no such row.  This means repeated subjects,
        predicates or objects of changes do not need to re-output for each
        quad.  This may allow significant compression at very low CPU-cost.
        General compression, like gzip streams, may still be usefully
        applied.
      </p>

      <p>
        If a element in a row is undefined in some row, a U is used to mark
        this (not used in RDF Patch)
      </p>

      <p>
        Prefixed names are allowed (e.g. rdf:type) using Turtle style @prefix and expansion
        rules.
      </p>

      <p>
        Relative URIs are not allowed.  There is no @base.
      </p>
    </section>

    <section>
      <h2>RDF Tuples Format</h2>

      <p><i>Outline grammar</i></p>

      <p>
        This uses the grammar and tokens from RDF 1.1 Turtle and SPARQL
        1.1.
      </p>

      <p>
        White space is allowed between tokens and may be needed to distinguish
        tokens.
      </p>

      <p>
        Comments are start with <tt>'#'</tt> and  run to the end of the
        line.
      </p>
        
<pre class="box">
Term     = iri | BlankNode | literal
RowItem  = WORD | Term | VAR
Row      = RowItem* DOT

WORD    = PN_CHARS_BASE PN_LOCAL without allowing ':'    # Must start with a letter.
VAR     = (from SPARQL)</pre>

    </section>

    <section>
      <h2>RDF Patch Use of RDF Tuples.</h2>
      
      <p>
        RDF patch uses RDF Tuples for triples or quads (N-Quad order).
      </p>

    </section>

    <section>
      <h2>RDF Patch Examples</h2>

    <section>
      <h3>Add a triple to a graph or default graph of the dataset</h3>
<pre class="box">
A &lt;http://example/bob&gt; &lt;http://xmlns.com/foaf/0.1/name&gt; "Bob" .
</pre>

      <p>This is the same as:</p>

<pre class="box">
@prefix  foaf: &lt;http://xmlns.com/foaf/0.1/&gt; .
A &lt;http://example/bob&gt; foaf:name "bob" .
</pre>

      <p>A slightly longer change: To add multiple triples:</p>

<pre class="box">
@prefix  foaf: &lt;http://xmlns.com/foaf/0.1/&gt; .
D &lt;http://example/bob&gt; foaf:name "bob" .
A &lt;http://example/bob&gt; foaf:name "Bob" .
A R foaf:knows "Bob" &lt;http://example/alice&gt; .
A R R &lt;http://example/charlie&gt; .
</pre>

      <p>In the last row, we add a triple</p>

<pre class="box">
&lt;http://example/bob&gt; &lt;http://xmlns.com/foaf/0.1/name&gt; &lt;http://example/charlie&gt; .
</pre>

      <p>The repeat marker can be used in any position and across adds and deletes</p>

<pre class="box">
@prefix  foaf: &lt;http://xmlns.com/foaf/0.1/&gt; .
A &lt;http://example/alice&gt; foaf:knows &lt;http://example/charlie&gt; .
A &lt;http://example/bob&gt; R R .
</pre>

<pre class="box">
@prefix  foaf: &lt;http://xmlns.com/foaf/0.1/&gt; .
D &lt;http://example/bob&gt; foaf:name "Robert" .
A R R "Bob" .
</pre>



    </section>

    <section>
      <h3>Named Graphs</h3>

      <p>Named graphs are changed by specifying quads</p>

<pre class="box">
A &lt;http://example/bob&gt; foaf:name "Bob" &lt;http://example/graphName&gt; .
</pre>

    </section>
    </section>

    <section>
      <h2>Minimize actions</h2>

      <p>
        A further way in which the size of a diff file can be reduced is to
        only record changes that do have an effect of a change.  And RDF
        Dataset is set of quads, no duplicates, so if a quad is added that
        is already in the dataset, then no record is needed as no effective
        change occurs.  Similarly for deletes, if the quad does not exist,
        a delete action has no effect.
      </p>

      <p>
        However, testing before every insert or delete can be expensive or
        otherwise impractical and so this style is not required.
        </p>

<pre class="box">
A &lt;http://example/s&gt; &lt;http://example/p&gt; &lt;http://example/o&gt; &lt;http://example/g&gt; .
A &lt;http://example/s&gt; &lt;http://example/p&gt; &lt;http://example/o&gt; &lt;http://example/g&gt; .
</pre>

      <p>has the same effect as:</p>

<pre class="box">
A &lt;http://example/s&gt; &lt;http://example/p&gt; &lt;http://example/o&gt; &lt;http://example/g&gt; .
</pre>

      <p>if there was no such quad in the dataset before the delta started.</p>

      <p>The quads don't need to be adjacent:</p>

<pre class="box">
A &lt;http://example/s&gt; &lt;http://example/p&gt; &lt;http://example/o&gt; &lt;http://example/g&gt; .
A &lt;http://example/other&gt; &lt;http://example/p&gt; 123 &lt;http://example/g2&gt; .
A &lt;http://example/s&gt; &lt;http://example/p&gt; &lt;http://example/o&gt; &lt;http://example/g&gt; .
</pre>

      <p>becomes</p>

<pre class="box">
A &lt;http://example/s&gt; &lt;http://example/p&gt; &lt;http://example/o&gt; &lt;http://example/g&gt; .
A &lt;http://example/other&gt; &lt;http://example/p&gt; 123 &lt;http://example/g2&gt; .
</pre>
      <p>
        When written in minimize form the RDF Patch can be run backwards,
        to undo a change.  This only works when real changes are recorded
        because otherwise knowing a triple is added does not mean it was
        not there before.
      </p>
    </section>
  </body>
</html>

  